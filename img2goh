#!/bin/bash

# set some variables
inf=$1
basef="${inf%.*}"
outf="$basef".pcx
gohf="$basef".goh

# convert any modern image format to old-school pcx
# the script "returns" the color index of the magenta background color
# we've added in the process of the conversion that we want to
# mask out for transparency using the "m" option in cvtpcx
identify $inf
colormapIdx=$(img2pcx $inf $outf | tail -n1)
identify $outf

# make sure we have the correct dimensions
width=`identify -format '%w' $outf`
height=`identify -format '%h' $outf`

# default stuff
style=icon
size=standard
aspect=normal

# -f => uses GrFillBitmap instead of GrDrawBitmap for all monochrome bitmaps
fill=

# -G => output GOH/GOC code instead of ESP/UI
doForGOC=

# -R => Don't put out resource start/end directives; just monikers
res=-R

# call the CVTPCX methusalem
cvtpcx -S"$style" \
       -s"$size" \
       -a"$aspect" \
       -w"$width" \
       -h"$height" \
       -m"$colormapIdx" \
       "$fill" \
       "$doForGOC" \
       "$res" \
       -2 \
       -o"$gohf" \
        $outf

# cleanup
rm $outf